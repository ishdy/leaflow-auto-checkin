name: Leaflow Auto Checkin

on:
  schedule:
    # æ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼šåŒ—äº¬æ—¶é—´ 08:15, 14:15, 20:15, 02:15
    - cron: '15 */6 * * *'
  workflow_dispatch:

jobs:
  checkin:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    # è·å–å½“å‰æ—¥æœŸä½œä¸º cache key
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    
    # å°è¯•æ¢å¤ä»Šå¤©çš„ç­¾åˆ°çŠ¶æ€
    - name: Restore checkin status
      id: cache-status
      uses: actions/cache@v3
      with:
        path: checkin_success.txt
        key: checkin-status-${{ steps.date.outputs.date }}
    
    # æ£€æŸ¥æ˜¯å¦ä»Šå¤©å·²ç»ç­¾åˆ°æˆåŠŸ
    - name: Check if already checked in today
      id: check-status
      run: |
        if [ -f checkin_success.txt ]; then
          echo "âœ… ä»Šå¤©å·²ç»ç­¾åˆ°æˆåŠŸï¼Œè·³è¿‡æ‰§è¡Œ"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "ğŸš€ éœ€è¦æ‰§è¡Œç­¾åˆ°"
          echo "skip=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Install dependencies
      if: steps.check-status.outputs.skip == 'false'
      run: |
        python -m pip install --upgrade pip
        pip install selenium requests
        
    - name: Run auto checkin
      if: steps.check-status.outputs.skip == 'false'
      id: checkin
      env:
        LEAFLOW_ACCOUNTS: ${{ secrets.LEAFLOW_ACCOUNTS }}
        LEAFLOW_EMAIL: ${{ secrets.LEAFLOW_EMAIL }}
        LEAFLOW_PASSWORD: ${{ secrets.LEAFLOW_PASSWORD }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_ACTIONS: true
      run: |
        python leaflow_checkin.py
        exit_code=$?
        
        # å¦‚æœè„šæœ¬æˆåŠŸæ‰§è¡Œï¼ˆé€€å‡ºç ä¸º0ï¼‰ï¼Œåˆ›å»ºæˆåŠŸæ ‡è®°æ–‡ä»¶
        if [ $exit_code -eq 0 ]; then
          echo "success" > checkin_success.txt
          echo "âœ… ç­¾åˆ°æˆåŠŸï¼Œåˆ›å»ºä»Šæ—¥æˆåŠŸæ ‡è®°"
        else
          echo "âŒ ç­¾åˆ°å¤±è´¥ï¼Œ6å°æ—¶åå°†é‡è¯•"
          exit $exit_code
        fi
    
    - name: Upload Debug Files
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-files-${{ github.run_number }}
        path: |
          *.png
          *.html
        retention-days: 3
